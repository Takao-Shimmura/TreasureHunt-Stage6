{% extends "layout.html"%}

{% block title%}

çµŒçµ¡çµŒç©´æ¦‚è«–ã€€Treasure Hunting
{% endblock%}

{% block headline%}
{{title}}

{% endblock%}
<!--{% block header%}
{{message}}
{% endblock%} -->

{% block content %}


<!-- Vue.js container -->

<div id="app" class="m-3">

    <message_board/>
</div>


<!-- message_board's template -->
{% raw %}
<!-- <script type="vue/x=template" id="message_board-template"> -->
<script type="text/x-template" id="message_board-template">
<div>
    <div class="text-right h6">
        <a href="javascript:void(0)"
        v-on:click="in_out_check">{{in_out}}</a>
    </div>
    <div class="alert alert-success p-1">
        <h5>{{alert_msg}}</h5>
    </div>

    <!--å…¥åŠ›ã€€æ²ç¤ºãƒ‘ãƒãƒ«-->
    <div class="card">
        <div class="card-header">
            <div v-if="login_flg">
                <div v-if="login_name=='admin'">
                    <div class="card mt-4">
                        <div class="card-body">
                            <div class="form-group">
                                <button v-on:click="postMsg"
                                    class="btn btn-primary col-12 col-sm-6 col-md-4 col-lg-4 col-xl-4">
                                    å…¥åŠ›å±¥æ­´æ›´æ–°</button>
                            </div>
                            <div class="form-group">
                                <button v-on:click="delMsg"
                                    class="btn btn-primary col-12 col-sm-6 col-md-4 col-lg-4 col-xl-4">
                                    å…¥åŠ›å±¥æ­´å‰Šé™¤</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-else>
                    <h5 class="mt-4">
                        ğŸ‘‡å…¨è§’ã‚«ã‚¿ã‚«ãƒŠã§å…¥åŠ›
                    </h5>
                    <div class="card mt-4">
                        <div class="card-body">
                            <div class="form-group">
                                <label for="comment">å…¥åŠ›æ¬„</label>
                                <div class="row">
                                <input type="text"  class="form-control col" 
                                    id="comment" name="comment" v-model="post_msg">
                                <button v-on:click="postMsg"
                                    class="btn btn-primary col-5 col-sm-4 col-md-4 col-lg-4 col-xl-4">
                                    é€ä¿¡/æ›´æ–°</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div v-if="login_flg">
                <h5 class="p-3 h5 text-center">
                    *å…¥åŠ›å±¥æ­´*
                </h5>
                <ul class="list-group list-group-flush">
                    <div v-if="login_name =='admin'">ã€€
                        <li v-for="item in msg_data"
                        class=" list-group-item">
                            <!-- â†‘ã€€login_nameãŒadminã ã£ãŸæ™‚ã«ã¯ã€å±¥æ­´ã®ã™ã¹ã¦ã‚’è¡¨ç¤º -->
                            {{item[1]}}({{item[0]}})
                        </li>
                    </div>
                    <div v-else>
                        <div v-for="item in msg_data">
                                <!-- â†‘ã€€åŒã˜group_nameã®äººãŒéå»ã«æ²è¼‰ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿è¡¨ç¤ºã—ã¦ã„ã -->
                            <li  class=" list-group-item">
                                {{item['input_key']}}     ({{item['name']}})
                            </li>
                        </div>
                    </div>
                </ul>
            </div>
        </div>

    </div>




    <!-- Login Dialog -->
    <div class="modal fade" id="login">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">
                            {{login_msg}}
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="group">ãƒãƒ¼ãƒ å</label>
                            <input type="text"  class="form-control " id="group_input" name="group_input" v-model="group_name">
                            <small class="form-text text-muted">
                                â€»ãƒãƒ¼ãƒ åã‚’åŠè§’å¤§æ–‡å­—ã§å…¥åŠ›
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="group">åå‰</label>
                            <input type="text"  class="form-control " id="name_input" name="name_input" v-model="name_id">
                            <small class="form-text text-muted">
                                â€»åå‰ã‚’åŠè§’å°æ–‡å­—ã§å…¥åŠ›
                            </small>
                        </div>
                        <div class="form-group">
                            <button class="btn btn=primary" v-on:click="login">ãƒ­ã‚°ã‚¤ãƒ³</button>
                        </div>
                    </div>
                </div>
            </div>   
        </div>
    </div>

    <!-- Hazure Dialog -->
    <div class="modal fade" id="Hazure">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">
                            ä¸æ­£è§£ï¼
                        </h4>
                    </div>
                    <div class="card-body">
                        <img class="card-img" src="/static/hazure_001.gif">
                    </div>
                    <div class="form-group">
                        <button class="btn btn=primary" v-on:click="closeHazure">é–‰ã˜ã‚‹</button>
                    </div>
                </div>
            </div>   
        </div>
    </div>



    <!-- TreasureBox Dialog -->
    <div class="modal fade" id="TreasureBox">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">
                            æ­£è§£ ãƒãƒ¼ãƒ {{form_msg}}ã€€å…¨ã‚¹ãƒ†ãƒ¼ã‚¸ã€€ã‚¯ãƒªã‚¢ï¼
                        </h4>
                    </div>
                    <div class="card-body">
                        <img class="card-img" src="/static/TreasureBoxOpen.gif">
                    </div>
                    <div class="form-group">
                        <button class="btn btn=primary" v-on:click="closeTresureBox">é–‰ã˜ã‚‹</button>
                    </div>
                </div>
            </div>   
        </div>
    </div>
</div>
</script>
{% endraw %}

<!-- ******************** -->
<!-- * Vue.js Component Script * -->
<!-- ******************** -->
<script>
    /*â†“â†“ã€€setIntervalé–¢æ•° (ä¸€å®šæ™‚é–“ãŒçµŒéã™ã‚‹ã¨ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•æ›´æ–°ã—ç¶šã‘ã¦ãã‚Œã‚‹)ã€€*/
    /*â†“â†“ã€€ã¨ã€clearIntervalé–¢æ•°ï¼ˆãã®è§£é™¤å½¹ã‚’ã—ã¦ãã‚Œã‚‹ï¼‰ã®ãŸã‚ã®ã€Œå¤‰æ•°ã€ã¨ã—ã¦ã€€*/
    /*â†“â†“ã€€ã‚ã‚‰ã‹ã˜ã‚è¨­å®šã—ã¦ãŠãã®ãŒintervalIDã€‚Vue.componentã®å¤–ã§è¨­å®šã—ãªã„ã¨ã€€*/
    /*â†“â†“ã€€Vueå†…ã®functionã‚’çµ‚ãˆã‚‹ãŸã³ã«æ¶ˆã•ã‚Œã¦ã—ã¾ã†ã®ã§ã€ã“ã“ã§å®£è¨€ã—ã¦ãŠãã€€*/
    /*â†“â†“ã€€å‚ç…§ã€€ã€€https://techacademy.jp/magazine/5537ã€€*/
var intervalID
//message_board object
Vue.component('message_board',{
    template:'#message_board-template',
    data:function(){

        return{
                in_out:'ãƒ­ã‚°ã‚¤ãƒ³',       
                login_flg:false,
                login_name:'',
                login_id:'',
                group_name:'',
                name_id:'',
                form_pass:'',
                login_msg:'ãƒ­ã‚°ã‚¤ãƒ³ã€€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦',
                alert_msg:'â€»ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„',
                post_msg:'',
                msg_data:[],
                form_msg:'',
                seikai_flg:'',
        }
    },
    methods:{
        // check login/logout.
        in_out_check:function(e){
            if(this.login_flg){
                this.logout();
            }else{
                this.show_login();
            }   
        },
        //show login dialog
        show_login:function(){
            this.group_name='';
            this.name_id='';
            this.login_id='';
            this.login_msg='ãƒ­ã‚°ã‚¤ãƒ³ã€€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦';
            $('#login').modal('show');
        },
        //show Hazure dialog
        showHazure:function(){
            $('#Hazure').modal('show');
        },
        //hide Hazure dialog
        closeHazure:function(){
            $('#Hazure').modal('hide');
        },
        //show TreasureBox dialog
        showTresureBox:function(){
            this.seikai_flg='';
            $('#TreasureBox').modal('show');
        },
        //hide TreasureBox dialog
        closeTresureBox:function(){
            $('#TreasureBox').modal('hide');
        },
        //access server and logined
        login:function(e){
            let formData= new FormData();
            formData.append("group_name",this.group_name);
            formData.append("name_id",this.name_id);
            let self=this;
            $.ajax({
                type:'POST',
                url:'/login',
                data:formData,
                processData:false,
                contentType:false,
            success:function(Data){
                if (Data[0]=='True'){
                    self.in_out='ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ';
                    self.login_flg=true;
                    self.login_name=Data[1];
                    self.group_name=Data[2];
                    self.login_id=Data[3];
                    self.alert_msg='â€»ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸï¼';
                    /* self.group_name=''; */
                    $('#login').modal('hide');
                    self.getMsg();
                    /*â†“â†“ã€€setInterval ã‚’ã¤ã‹ã†ã“ã¨ã§ã€ä¸€å®šæ™‚é–“ãŒçµŒéã™ã‚‹ã¨
                    ã€€ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•æ›´æ–°ã—ç¶šã‘ã¦ãã‚Œã‚‹ã€€*/
                /*â†“â†“ã€€getMsgã¨ã„ã†é–¢æ•°ã‚’å®šæœŸçš„ã«è‡ªå‹•æ›´æ–°ã—ç¶šã‘ã¦ãã‚Œã‚‹ã€€*/
                /*â†“â†“ã€€ã‚³ãƒ„ã¯ã€Ã—ã€€getMsg() ã§ã¯ãªã   â—‹ã€€getMsgã€€ã¨ã™ã‚‹ã“ã¨ã€€*/
                /*â†“â†“ã€€logout() æ™‚ã«ã€clearInterval()é–¢æ•°ã§è§£é™¤ã•ã‚Œã‚‹ã€€*/
                /*â†“â†“ã€€å‚ç…§ã€€ã€€https://techacademy.jp/magazine/5537ã€€*/
                    
                    intervalID = setInterval(self.getMsg,10000);
                    
                }else{
                    self.login_msg='ã€Œãƒãƒ¼ãƒ åã€ã‚‚ã—ãã¯ã€Œåå‰ã€ãŒé•ã„ã¾ã™';

                }
            },
            error:function(request,status,err){
                self.login_msg='â€»å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ';

            }
        });
    },
    //logout
    logout:function(){
        console.log('logout');
        this.in_out='ãƒ­ã‚°ã‚¤ãƒ³';
        this.msg_data=[];
        this.login_flg=false;
        this.login_name='';
        this.login_id='';
        this.alert_msg='â€»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ';
        /*â†“â†“ã€€clearIntervalã«ã‚ˆã£ã¦ã€setIntervalã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•æ›´æ–°ã‚’
        ã‚¹ãƒˆãƒƒãƒ—ã•ã›ã‚‹ã€€*/
        /*â†“â†“ã€€å‚ç…§ã€€ã€€https://techacademy.jp/magazine/5537ã€€*/
        clearInterval(intervalID);

    },
    //post message.
    postMsg:function(){
        let formData=new FormData();
        formData.append("comment",this.post_msg);
        let self=this;
        $.ajax({
            type:'POST',
            url:'/post',
            data:formData,
            processData:false,
            contentType:false,

            success:function(DAT){
                self.post_msg = '';
                self.seikai_flg=DAT[1]
               if(DAT[0]== 'True' &&  self.seikai_flg=='hazure' ) {    
                    self.alert_msg ='ä¸æ­£è§£ï¼';
                    self.seikai_flg='';
                    self.showHazure();      
                    self.getMsg();  
                }else if(DAT[0]== 'True' && self.seikai_flg=='atari' ) {     
                    self.getMsg();  
                    }
            },
            
            error:function(request,status,err){
                self.alert_msg='â€»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ';

            }
        });
        
    },
    //delete message.
    delMsg:function(){
        let self = this;
        $.ajax({
            type:'POST',
            url:'/delete',
            processData:false,
            contentType:false,
            success:function(DAT){
                if (DAT== 'True') {
                    self.seikai_flg='';
                    self.alert_msg ='å…¥åŠ›å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ';
                    self.getMsg(); 
                }
            },
            
            error:function(request,status,err){
                self.alert_msg='â€»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ';

            }
        });
        
    },  
  // get all messages.
        getMsg: function() {
            let self = this;
            $.ajax({
                type: 'POST',
                url: '/messages',
                processData: false,
                contentType: false,

                success: function (DATA) {
                    /* console.log(DATA); */ 
                    self.msg_data = DATA.reverse();
                    
                
                    if(self.seikai_flg=='atari' ) {     
                     
                        self.seikai_flg='';
                        /* console.log(DATA[0]['group']);
                        console.log(self.group_name); */
                        self.alert_msg = 'â€»å…¨ã‚¹ãƒ†ãƒ¼ã‚¸ ã‚¯ãƒªã‚¢ï¼';
                        /* self.form_msg = DATA[0][0];
                        && DATA[0]['group'] == self.group_name  */
                        
                        /* if(self.seikai_flg){ */
                        self.showTresureBox();
                        /* }
                        self.showTresureBox(); */
                    };
                    
                },
                error: function(request, status, err) {
                    self.alert_msg = 'â€»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                }
            });
        } 
    },    
});
//start Vue.
new Vue({
    el:'#app',
});
</script>


{% endblock%}

{% block footer%}
copyright=shim
{% endblock%}