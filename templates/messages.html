{% extends "layout.html"%}

{% block title%}

経絡経穴概論　Treasure Hunting
{% endblock%}

{% block headline%}
{{title}}

{% endblock%}
<!--{% block header%}
{{message}}
{% endblock%} -->

{% block content %}


<!-- Vue.js container -->

<div id="app" class="m-3">

    <message_board/>
</div>


<!-- message_board's template -->
{% raw %}
<!-- <script type="vue/x=template" id="message_board-template"> -->
<script type="text/x-template" id="message_board-template">
<div>
    <div class="text-right h6">
        <a href="javascript:void(0)"
        v-on:click="in_out_check">{{in_out}}</a>
    </div>
    <div class="alert alert-success p-1">
        <h5>{{alert_msg}}</h5>
    </div>

    <!--入力　掲示パネル-->
    <div class="card">
        <div class="card-header">
            <div v-if="login_flg">
                <div v-if="login_name=='admin'">
                    <div class="card mt-4">
                        <div class="card-body">
                            <div class="form-group">
                                <button v-on:click="postMsg"
                                    class="btn btn-primary col-12 col-sm-6 col-md-4 col-lg-4 col-xl-4">
                                    入力履歴更新</button>
                            </div>
                            <div class="form-group">
                                <button v-on:click="delMsg"
                                    class="btn btn-primary col-12 col-sm-6 col-md-4 col-lg-4 col-xl-4">
                                    入力履歴削除</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-else>
                    <h5 class="mt-4">
                        👇全角カタカナで入力
                    </h5>
                    <div class="card mt-4">
                        <div class="card-body">
                            <div class="form-group">
                                <label for="comment">入力欄</label>
                                <div class="row">
                                <input type="text"  class="form-control col" 
                                    id="comment" name="comment" v-model="post_msg">
                                <button v-on:click="postMsg"
                                    class="btn btn-primary col-5 col-sm-4 col-md-4 col-lg-4 col-xl-4">
                                    送信/更新</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div v-if="login_flg">
                <h5 class="p-3 h5 text-center">
                    *入力履歴*
                </h5>
                <ul class="list-group list-group-flush">
                    <div v-if="login_name =='admin'">　
                        <li v-for="item in msg_data"
                        class=" list-group-item">
                            <!-- ↑　login_nameがadminだった時には、履歴のすべてを表示 -->
                            {{item[1]}}({{item[0]}})
                        </li>
                    </div>
                    <div v-else>
                        <div v-for="item in msg_data">
                                <!-- ↑　同じgroup_nameの人が過去に掲載したメッセージのみ表示していく -->
                            <li  class=" list-group-item">
                                {{item['input_key']}}     ({{item['name']}})
                            </li>
                        </div>
                    </div>
                </ul>
            </div>
        </div>

    </div>




    <!-- Login Dialog -->
    <div class="modal fade" id="login">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">
                            {{login_msg}}
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="group">チーム名</label>
                            <input type="text"  class="form-control " id="group_input" name="group_input" v-model="group_name">
                            <small class="form-text text-muted">
                                ※チーム名を半角大文字で入力
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="group">名前</label>
                            <input type="text"  class="form-control " id="name_input" name="name_input" v-model="name_id">
                            <small class="form-text text-muted">
                                ※名前を半角小文字で入力
                            </small>
                        </div>
                        <div class="form-group">
                            <button class="btn btn=primary" v-on:click="login">ログイン</button>
                        </div>
                    </div>
                </div>
            </div>   
        </div>
    </div>

    <!-- Hazure Dialog -->
    <div class="modal fade" id="Hazure">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">
                            不正解！
                        </h4>
                    </div>
                    <div class="card-body">
                        <img class="card-img" src="/static/hazure_001.gif">
                    </div>
                    <div class="form-group">
                        <button class="btn btn=primary" v-on:click="closeHazure">閉じる</button>
                    </div>
                </div>
            </div>   
        </div>
    </div>



    <!-- TreasureBox Dialog -->
    <div class="modal fade" id="TreasureBox">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">
                            正解 チーム{{form_msg}}　全ステージ　クリア！
                        </h4>
                    </div>
                    <div class="card-body">
                        <img class="card-img" src="/static/TreasureBoxOpen.gif">
                    </div>
                    <div class="form-group">
                        <button class="btn btn=primary" v-on:click="closeTresureBox">閉じる</button>
                    </div>
                </div>
            </div>   
        </div>
    </div>
</div>
</script>
{% endraw %}

<!-- ******************** -->
<!-- * Vue.js Component Script * -->
<!-- ******************** -->
<script>
    /*↓↓　setInterval関数 (一定時間が経過するとデータを自動更新し続けてくれる)　*/
    /*↓↓　と、clearInterval関数（その解除役をしてくれる）のための「変数」として　*/
    /*↓↓　あらかじめ設定しておくのがintervalID。Vue.componentの外で設定しないと　*/
    /*↓↓　Vue内のfunctionを終えるたびに消されてしまうので、ここで宣言しておく　*/
    /*↓↓　参照　　https://techacademy.jp/magazine/5537　*/
var intervalID
//message_board object
Vue.component('message_board',{
    template:'#message_board-template',
    data:function(){

        return{
                in_out:'ログイン',       
                login_flg:false,
                login_name:'',
                login_id:'',
                group_name:'',
                name_id:'',
                form_pass:'',
                login_msg:'ログイン　ウィンドウ',
                alert_msg:'※ログインしてください',
                post_msg:'',
                msg_data:[],
                form_msg:'',
                seikai_flg:'',
        }
    },
    methods:{
        // check login/logout.
        in_out_check:function(e){
            if(this.login_flg){
                this.logout();
            }else{
                this.show_login();
            }   
        },
        //show login dialog
        show_login:function(){
            this.group_name='';
            this.name_id='';
            this.login_id='';
            this.login_msg='ログイン　ウィンドウ';
            $('#login').modal('show');
        },
        //show Hazure dialog
        showHazure:function(){
            $('#Hazure').modal('show');
        },
        //hide Hazure dialog
        closeHazure:function(){
            $('#Hazure').modal('hide');
        },
        //show TreasureBox dialog
        showTresureBox:function(){
            this.seikai_flg='';
            $('#TreasureBox').modal('show');
        },
        //hide TreasureBox dialog
        closeTresureBox:function(){
            $('#TreasureBox').modal('hide');
        },
        //access server and logined
        login:function(e){
            let formData= new FormData();
            formData.append("group_name",this.group_name);
            formData.append("name_id",this.name_id);
            let self=this;
            $.ajax({
                type:'POST',
                url:'/login',
                data:formData,
                processData:false,
                contentType:false,
            success:function(Data){
                if (Data[0]=='True'){
                    self.in_out='ログアウト';
                    self.login_flg=true;
                    self.login_name=Data[1];
                    self.group_name=Data[2];
                    self.login_id=Data[3];
                    self.alert_msg='※ログインしました！';
                    /* self.group_name=''; */
                    $('#login').modal('hide');
                    self.getMsg();
                    /*↓↓　setInterval をつかうことで、一定時間が経過すると
                    　データを自動更新し続けてくれる　*/
                /*↓↓　getMsgという関数を定期的に自動更新し続けてくれる　*/
                /*↓↓　コツは、×　getMsg() ではなく   ○　getMsg　とすること　*/
                /*↓↓　logout() 時に、clearInterval()関数で解除される　*/
                /*↓↓　参照　　https://techacademy.jp/magazine/5537　*/
                    
                    intervalID = setInterval(self.getMsg,10000);
                    
                }else{
                    self.login_msg='「チーム名」もしくは「名前」が違います';

                }
            },
            error:function(request,status,err){
                self.login_msg='※問題が発生しました';

            }
        });
    },
    //logout
    logout:function(){
        console.log('logout');
        this.in_out='ログイン';
        this.msg_data=[];
        this.login_flg=false;
        this.login_name='';
        this.login_id='';
        this.alert_msg='※ログアウトしました';
        /*↓↓　clearIntervalによって、setIntervalによるデータの自動更新を
        ストップさせる　*/
        /*↓↓　参照　　https://techacademy.jp/magazine/5537　*/
        clearInterval(intervalID);

    },
    //post message.
    postMsg:function(){
        let formData=new FormData();
        formData.append("comment",this.post_msg);
        let self=this;
        $.ajax({
            type:'POST',
            url:'/post',
            data:formData,
            processData:false,
            contentType:false,

            success:function(DAT){
                self.post_msg = '';
                self.seikai_flg=DAT[1]
               if(DAT[0]== 'True' &&  self.seikai_flg=='hazure' ) {    
                    self.alert_msg ='不正解！';
                    self.seikai_flg='';
                    self.showHazure();      
                    self.getMsg();  
                }else if(DAT[0]== 'True' && self.seikai_flg=='atari' ) {     
                    self.getMsg();  
                    }
            },
            
            error:function(request,status,err){
                self.alert_msg='※メッセージ送信に問題が発生しました';

            }
        });
        
    },
    //delete message.
    delMsg:function(){
        let self = this;
        $.ajax({
            type:'POST',
            url:'/delete',
            processData:false,
            contentType:false,
            success:function(DAT){
                if (DAT== 'True') {
                    self.seikai_flg='';
                    self.alert_msg ='入力履歴を削除しました';
                    self.getMsg(); 
                }
            },
            
            error:function(request,status,err){
                self.alert_msg='※メッセージ送信に問題が発生しました';

            }
        });
        
    },  
  // get all messages.
        getMsg: function() {
            let self = this;
            $.ajax({
                type: 'POST',
                url: '/messages',
                processData: false,
                contentType: false,

                success: function (DATA) {
                    /* console.log(DATA); */ 
                    self.msg_data = DATA.reverse();
                    
                
                    if(self.seikai_flg=='atari' ) {     
                     
                        self.seikai_flg='';
                        /* console.log(DATA[0]['group']);
                        console.log(self.group_name); */
                        self.alert_msg = '※全ステージ クリア！';
                        /* self.form_msg = DATA[0][0];
                        && DATA[0]['group'] == self.group_name  */
                        
                        /* if(self.seikai_flg){ */
                        self.showTresureBox();
                        /* }
                        self.showTresureBox(); */
                    };
                    
                },
                error: function(request, status, err) {
                    self.alert_msg = '※メッセージ送信に問題が発生しました。';
                }
            });
        } 
    },    
});
//start Vue.
new Vue({
    el:'#app',
});
</script>


{% endblock%}

{% block footer%}
copyright=shim
{% endblock%}